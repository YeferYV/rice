#!/usr/bin/env bash

#=================== Docker run ubuntu-nix ===================#

# xhost + && su -w WEZTERM_PANE,WEZTERM_UNIX_SOCKET,LESSKEYIN -
# docker run -it --name ubuntu-nix -v ${PWD%/*}:/home/dtfls//CICD-docker-volume ubuntu bash -uelic '
#     [[ ! -e /home/drksl ]] && {
#         apt update
#         DEBIAN_FRONTEND=noninteractive apt install -y sudo
#         useradd -mG sudo,tty drksl
#         echo root:toor | chpasswd
#         echo drksl:toor | chpasswd
#         echo "%sudo ALL=(ALL:ALL) NOPASSWD: ALL" > /etc/sudoers.d/wheel
#         chown -R drksl:drksl /home/dtfls
#         sudo -u "drksl" bash -c "/home/dtfls/CICD-docker-volume/CICD/install"
#     }
#     chmod g+w /dev/pts/0
#     su - drksl
#     '

#======== Post-Install: ubuntu-nix arch-nix nixos-nix ========#

# exit on error
set -eu

APT_INSTALL=true
PACMAN_INSTALL=true
NIX_INSTALL=true

# dependencies
[ "$APT_INSTALL" = "true" ] && [ -e /etc/apt ] && sudo apt update && sudo DEBIAN_FRONTEND=noninteractive apt install -y curl file fuse sudo tmux unzip xz-utils zsh
[ "$PACMAN_INSTALL" = "true" ] && [ -e /etc/pacman.d ] && sudo pacman -Syu --noconfirm curl fuse2 sudo tmux xz zsh

# install nix
[ "$NIX_INSTALL" = "true" ] && [ "$(id -u)" != 0 ] && {
    export NIX_PKGS_OS="nixpkgs"
    [ ! -e /nix ] && {
      curl -L nixos.org/nix/install | sh
    }
    [ -e /etc/nixos ] && {
      export NIX_PKGS_OS="nixos"
      nix-env -iA ${NIX_PKGS_OS}.zsh ${NIX_PKGS_OS}.tmux
    }
    . "$HOME/.nix-profile/etc/profile.d/nix.sh"
    nix-env -iA ${NIX_PKGS_OS}.bat ${NIX_PKGS_OS}.fzf ${NIX_PKGS_OS}.gcc ${NIX_PKGS_OS}.git ${NIX_PKGS_OS}.killall ${NIX_PKGS_OS}.lazygit \
                ${NIX_PKGS_OS}.libsixel ${NIX_PKGS_OS}.less ${NIX_PKGS_OS}.lf ${NIX_PKGS_OS}.ripgrep ${NIX_PKGS_OS}.timg ${NIX_PKGS_OS}.trash-cli \
                ${NIX_PKGS_OS}.xclip ${NIX_PKGS_OS}.xdg-utils ${NIX_PKGS_OS}.spaceship-prompt ${NIX_PKGS_OS}.zsh-autosuggestions ${NIX_PKGS_OS}.zsh-fast-syntax-highlighting
    nix-collect-garbage -d
  }

# install neovim.appimage v0.7.2 (nixpkgs.neovim doesn't work in codespaces) + nvchad
[ -e /.dockerenv ] && echo "export APPIMAGE_EXTRACT_AND_RUN=1" >> "$HOME"/.zprofile
sudo curl -Lo /usr/local/bin/nvim https://github.com/neovim/neovim/releases/download/v0.7.2/nvim.appimage && chmod +x /usr/local/bin/nvim
git clone --depth=1 https://github.com/nvchad/nvchad ~/.config/nvim

# source zsh plugins
cat <<"====" >> "$HOME/.zprofile"
    export DISPLAY=:0
    export EDITOR="nvim"
    export HISTFILE=~/.cache/history
    export LANG=en_US.UTF-8
    export LF_ICONS=" tw=:or=:ex=:bd=:di=:ow=:ln=:fi="
    export LS_COLORS="tw=30:or=91:ex=92:bd=93:di=94:ow=14:ln=34:fi=37"
    export PAGER="less -r --use-color -Dd+r -Du+b -DPyk -DSyk"
    export BAT_THEME="base16"
    export PATH="$PATH:$HOME/.local/bin"
    export SAVEHIST=10000000
    export SPACESHIP_PROMPT_ADD_NEWLINE="false"
    export SPACESHIP_PROMPT_SEPARATE_LINE="false"
    export SPACESHIP_VI_MODE_SHOW="false"
    export TERM="xterm-256color"
    source $HOME/.nix-profile/share/fzf/completion.zsh
    source $HOME/.nix-profile/share/fzf/key-bindings.zsh
    source $HOME/.nix-profile/share/zsh/site-functions/fast-syntax-highlighting.plugin.zsh
    source $HOME/.nix-profile/share/zsh-autosuggestions/zsh-autosuggestions.zsh
    source $HOME/.nix-profile/lib/spaceship-prompt/spaceship.zsh
    source $HOME/.nix-profile/etc/profile.d/nix.sh >/dev/null 2>&1
    tty >> /tmp/sixel-$WEZTERM_PANE
    trap "rm /tmp/sixel-$WEZTERM_PANE" EXIT
    [[ -z $TMUX ]] && sleep 1 && exec tmux -u
    [[ $USER != codespace ]] && [[ -e /.dockerenv ]] && echo "/dev/pts/0" >/tmp/sixel-$WEZTERM_PANE
    bindkey -v '^?' backward-delete-char
    function zle-keymap-select () {
        case $KEYMAP in
            vicmd) echo -ne '\e[2 q';;      # block
            viins|main) echo -ne '\e[6 q';; # beam
        esac
    }
    zle -N zle-keymap-select
    zle-line-init() {
        zle -K viins
        echo -ne "\e[6 q"
    }
    zle -N zle-line-init
    preexec() { echo -ne '\e[6 q' ;} # Use beam shape cursor for each new prompt.
    ## Basic auto/tab complete:
    autoload -U compinit && compinit -u
    zmodload zsh/complist
    zstyle ':completion:*' menu select
    _comp_options+=(globdots)		# Include hidden files.
    bindkey -M menuselect 'h' vi-backward-char
    bindkey -M menuselect 'l' vi-forward-char
    bindkey -M menuselect 'j' vi-down-line-or-history
    bindkey -M menuselect 'k' vi-up-line-or-history
    bindkey -v '^?' backward-delete-char
====

# zshrc for nvchad-terminal
if [ -e "$HOME/.bashrc" ]; then echo "/bin/zsh -l"           >> "$HOME/.bashrc"; fi;
if [ -e "$HOME/.zshrc" ]; then echo "source $HOME/.zprofile" >> "$HOME/.zshrc"; else ln -s "$HOME/.zprofile" "$HOME/.zshrc"; fi;

# lfcd
mkdir -p "$HOME/.config/lf" \
    && curl -L "https://raw.githubusercontent.com/gokcehan/lf/master/etc/lfcd.sh"  >> "$HOME/.zprofile"    \
    && echo -E "zle -N lfcd </dev/tty"                                             >> "$HOME/.zprofile"    \
    && echo -E "bindkey '\eo' 'lfcd'"                                              >> "$HOME/.zprofile"    \
    && sed -i 's/cd "$dir"/cd "$dir" \&\& zle reset-prompt/'                          "$HOME/.zprofile"    #\
    # && cp -r /home/*/.nix-profile $HOME  #if running as root

# lfrc
cat <<"====">> "$HOME/.config/lf/lfrc"
set icons
set hidden true
set ratios 1:2
set shell /bin/bash
set previewer ~/.config/lf/previewer
set cleaner ~/.config/lf/cleaner

cmd open ${{
    case $(file --dereference --brief --mime-type $f) in
        text/*|application/json) $EDITOR $fx ;;
        *) for f in $fx; do xdg-open $f &>/dev/null & disown; done;;
    esac
}}

cmd fzf_ripgrep ${{
  IFS=: read -ra selected < <(
    rg --color=always --line-number --no-heading --smart-case "${*:-}" |
      fzf --ansi \
          --color "hl:-1:underline,hl+:-1:underline:reverse" \
          --delimiter : \
          --preview 'bat --color=always {1} --highlight-line {2}' \
          --preview-window 'up,60%,border-bottom,+{2}+3/3,~3'
  )
  [ -n "${selected[0]}" ] && lf -remote "send $id select \"${selected[0]}\""
  [ -n "${selected[0]}" ] && nvim "${selected[0]}" "+${selected[1]}"
}}

map i       $[[ $fx =~ .png|.jpg ]] && img2sixel --loop-control=disable $fx | less -r >$(head -n1 /tmp/sixel-$WEZTERM_PANE) && lf -remote "send $id reload redraw" || bat --paging=always --wrap=never $fx
map o       $( timg -pi --loops=1 --frames=1 $fx | less -rX) >$(head -n1 /tmp/sixel-$WEZTERM_PANE) && lf -remote "send $id reload redraw"
map gmi     $[[ $fx =~ .png|.jpg ]] && img2sixel --loop-control=disable $fx | less -r >$(head -n1 /tmp/sixel-$WEZTERM_PANE) && lf -remote "send $id reload redraw" || bat --paging=always --wrap=never $fx
map gmo     $( timg -pi --loops=1 --frames=1 $fx | less -rX) >$(head -n1 /tmp/sixel-$WEZTERM_PANE) && lf -remote "send $id reload redraw"
map gms     $wezterm cli split-pane --horizontal -- bash -c "timg --center $fx && read"
map gmt     $wezterm cli spawn -- bash -c "timg --center $fx && read"
map gll     $lazygit
map gfs     $lf -remote "send $id select \"$(fzf --bind='?:toggle-preview' --preview 'bat --color=always {}' --preview-window 'right,50%,border-left' </dev/tty)\""
map gfr     :fzf_ripgrep
map <enter> shell
map D       $trash --trash-dir ~/.cache/Trash $fx
map J       half-down
map K       half-up
====

# lf previewer
cat <<"====">> "$HOME/.config/lf/previewer"
#!/bin/bash
[[ $1 =~ .png|.jpg ]] && (tput cup $5 $4 && img2sixel --loop-control=disable -w $((${2}*8)) $1) >$(head -n1 /tmp/sixel-$WEZTERM_PANE) && exit 1 || bat --style=plain --color=always $1
====

# lf cleaner
cat <<"====">> "$HOME/.config/lf/cleaner"
#!/bin/bash
killall -s SIGWINCH lf
====

# lf executables
chmod +x "$HOME"/.config/lf/{previewer,cleaner} \

# use zsh as default shell
sudo chsh -s "$(which zsh)" "$USER"

# tmux config
cat <<====>> "$HOME/.tmux.conf"
    set  -g  default-shell             /bin/zsh
    set  -g  mouse                     on
    set  -g  pane-active-border-style  fg=colour235
    set  -g  status                    off
    set  -g  status-bg                 colour233
    set  -g  status-fg                 colour245
    setw -g  mode-keys                 vi
    set  -ga terminal-overrides        "xterm-256color:Tc"
    bind -T  copy-mode-vi y            send-keys -X copy-pipe-and-cancel "xclip -i -sel clip > /dev/null"
    bind -T  copy-mode-vi v            send-keys -X begin-selection
    bind -n  C-M-l                     send-keys C-l \; run 'tmux clear-history'
    bind     Space                     copy-mode \; send-keys left left
    bind -n  C-M-Space                 copy-mode \; send-keys left left
    bind -n  C-M-h                     copy-mode \; send-keys left left
    bind -n  M-w                       copy-mode \; send-keys left left \; send-keys -X scroll-up
    bind -n  M-s                       copy-mode \; send-keys left left \; send-keys -X scroll-down
    bind -n  M-e                       copy-mode \; send-keys left left \; send-keys -X scroll-up
    bind -n  M-d                       copy-mode \; send-keys left left \; send-keys -X scroll-down
    bind -n  M-r                       copy-mode \; send-keys left left \; send-keys -X page-up
    bind -n  M-f                       copy-mode \; send-keys left left \; send-keys -X page-down
    bind -n  M-t                       copy-mode \; send-keys left left \; send-keys -X history-top
    bind -n  M-g                       copy-mode \; send-keys left left \; send-keys -X history-bottom
    bind -T  copy-mode-vi M-w          send-keys -X scroll-up
    bind -T  copy-mode-vi M-s          send-keys -X scroll-down
    bind -T  copy-mode-vi M-e          send-keys -X scroll-up
    bind -T  copy-mode-vi M-d          send-keys -X scroll-down
    bind -T  copy-mode-vi M-r          send-keys -X page-up
    bind -T  copy-mode-vi M-f          send-keys -X page-down
    bind -T  copy-mode-vi M-t          send-keys -X history-top
    bind -T  copy-mode-vi M-g          send-keys -X history-bottom
    bind -T  copy-mode-vi u            send-keys -X halfpage-up
    bind -T  copy-mode-vi d            send-keys -X halfpage-down
    bind -T  copy-mode-vi i            send-keys -X cancel
    bind -T  copy-mode-vi H            send-keys left  left  left  left  left  left  left  left  left  left
    bind -T  copy-mode-vi J            send-keys down  down  down  down  down  down  down  down  down  down
    bind -T  copy-mode-vi K            send-keys up    up    up    up    up    up    up    up    up    up
    bind -T  copy-mode-vi L            send-keys right right right right right right right right right right
    bind -n  C-M-b                     set -g status
    bind     b                         set -g status
    bind     c                         set -g status on \; new-window
    bind     x                         kill-pane
    bind     v                         split-window -h
    bind     V                         split-window -v
    bind -n  C-M-n                     select-window -n
    bind -n  C-M-p                     select-window -p
    bind -n  C-Left                    select-pane -L
    bind -n  C-Down                    select-pane -D
    bind -n  C-Up                      select-pane -U
    bind -n  C-Right                   select-pane -R
    bind -r  h                         select-pane -L
    bind -r  j                         select-pane -D
    bind -r  k                         select-pane -U
    bind -r  l                         select-pane -R
    bind -r  H                         resize-pane -L
    bind -r  J                         resize-pane -D
    bind -r  K                         resize-pane -U
    bind -r  L                         resize-pane -R
====
tput -T ansi setaf 2; echo Done!
